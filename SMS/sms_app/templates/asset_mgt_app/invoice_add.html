{% extends "asset_mgt_app/base.html" %}
{% load widget_tweaks %}
{% block content %}
<!--<div class="col-md-1">-->
<!--	<a href="{% url 'gatein_list' %}" class="btn btn-primary btn-block btn-lg">-->
<!--		<i class="fas fa-arrow-left"></i>-->
<!--	</a>-->
<!--</div>-->

<form method="POST" id="invoice_add" action="" data-load_customer_model-url="{% url 'load_whrate_model' %}" >
	{% csrf_token %}
	<div class="row">
		<div class="col-1"></div>
		<div class="col-10">
			<div class="container-fluid">
				<div class="card text-white bg-info mb-3" style="max-width: 100%;">
					<div class="card-header text-center"><h3>Add/Update Invoice</h3></div>
					<div class="card-body bg-light" >
						<div class="row">
							<div class="col-4">
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Invoice Date</span>
									</div>
									{% render_field invoice_form.bill_invoice_date type="date" id="bill_invoice_date" class="form-control" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">BVM Invoice Number</span>
									</div>
									{% render_field invoice_form.bill_invoice_ref id="bill_invoice_ref" class="form-control" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Customer Name</span>
									</div>
									{% render_field invoice_form.bill_customer_name id="bill_customer_name" class="form-control" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Customer Short Name</span>
									</div>
									{% render_field invoice_form.bill_customer_short_name id="bill_customer_short_name" class="form-control disable_a_href" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Customer Model</span>
									</div>
									{% render_field invoice_form.bill_customer_type id="bill_customer_type" class="form-control disable_a_href" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Customer Code</span>
									</div>
									{% render_field invoice_form.bill_customer_code id="bill_customer_code" class="form-control disable_a_href" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">GSTIN</span>
									</div>
									{% render_field invoice_form.bill_customer_GST id="bill_customer_GST" class="form-control disable_a_href" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Customer Person</span>
									</div>
									{% render_field invoice_form.bill_customer_person id="bill_customer_person" class="form-control disable_a_href" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Customer Contact</span>
									</div>
									{% render_field invoice_form.bill_customer_contact id="bill_customer_contact" class="form-control disable_a_href" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Address</span>
									</div>
									{% render_field invoice_form.bill_customer_address id="bill_customer_address" class="form-control disable_a_href" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
							</div>
							<div class="col-4">
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">e-invoice</span>
									</div>
									{% render_field invoice_form.bill_e_invoice id="bill_e_invoice" class="form-control" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Billing Start Date</span>
									</div>
									{% render_field invoice_form.bill_start_date type="date" id="bill_start_date" class="form-control " %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Billing End Date</span>
									</div>
									{% render_field invoice_form.bill_end_date type="date" id="bill_end_date" class="form-control " %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Shipment Weight (kg)</span>
									</div>
									{% render_field invoice_form.bill_weight id="bill_weight" class="form-control disable_a_href" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">No of Pieces</span>
									</div>
									{% render_field invoice_form.bill_no_of_pallets class="form-control disable_a_href" id="bill_no_of_pallets" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">No Of Days</span>
									</div>
									{% render_field invoice_form.bill_no_of_days class="form-control disable_a_href" id="bill_no_of_days" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Wh Storage cost (INR)</span>
									</div>
									{% render_field invoice_form.bill_wh_storage_charges class="form-control disable_a_href" id="bill_wh_storage_charges" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Loading Cost (INR)</span>
									</div>
									{% render_field invoice_form.bill_loading_charge class="form-control disable_a_href" id="bill_loading_charge" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Unloading Cost (INR)</span>
									</div>
									{% render_field invoice_form.bill_unloading_charge class="form-control disable_a_href" id="bill_unloading_charge" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Fumigation Cost (INR)</span>
									</div>
									{% render_field invoice_form.bill_tot_fumigation_charges class="form-control" id="bill_tot_fumigation_charges" onchange="fumigation_charge_change_fn()" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								{% render_field invoice_form.bill_updated_by id="bill_updated_by" hidden="True" class="form-control" %}
								{% render_field invoice_form.bill_updated_at id="bill_updated_at"  class="form-control" %}
								{% render_field invoice_form.bill_created_on id="bill_created_on"  class="form-control" %}
							</div>
							<div class="col-4">
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Crane Hours</span>
									</div>
									{% render_field invoice_form.bill_tot_crane_time class="form-control disable_a_href" id="bill_tot_crane_time" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Forklift Hours</span>
									</div>
									{% render_field invoice_form.bill_tot_forklift_time class="form-control disable_a_href" id="bill_tot_forklift_time" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Crane Cost (INR)</span>
									</div>
									{% render_field invoice_form.bill_tot_crane_charges class="form-control disable_a_href" id="bill_tot_crane_charges" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Forklift Cost (INR)</span>
									</div>
									{% render_field invoice_form.bill_tot_forklift_charges class="form-control disable_a_href" id="bill_tot_forklift_charges" %}
								</div>

								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total (Before GST) (INR)</span>
									</div>
									{% render_field invoice_form.bill_total_pre_gst class="form-control disable_a_href" id="bill_total_pre_gst" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">CGST (@9%) (INR)</span>
									</div>
									{% render_field invoice_form.bill_cgst class="form-control disable_a_href" id="bill_cgst" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">SGST (@9%) (INR)</span>
									</div>
									{% render_field invoice_form.bill_sgst class="form-control disable_a_href" id="bill_sgst" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Post GST (INR)</span>
									</div>
									{% render_field invoice_form.bill_total_post_gst class="form-control disable_a_href" id="bill_total_post_gst" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Status</span>
									</div>
									{% render_field invoice_form.bill_status class="form-control" id="bill_status" %}
									<!--<input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">-->
								</div>
							</div>
						</div>
						<button type="submit" class="btn btn-success" onclick="myjobnum()"><i class="fas fa-check"></i> Save</button>
						<a href="{% url 'invoice_list' %}" class="btn btn-danger float-right">
							<i class="fas fa-times"></i> Cancel </a>
					</div>
				</div>
			</div>
		</div>
		<div class="col-1"></div>
	</div>
	<div class="row">
		<div class="col-1"></div>
		<div class="col-10">
			<div class="message text-center">
				{% for message in messages %}
				<a {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</a>
				{% endfor %}
			</div>
		</div>
		<div class="col-1"></div>
	</div>
	{% include "asset_mgt_app/shipper_invoice_list_WOH.html" %}
</form>

<script>
$(document).ready(function() {
	document.getElementById("bill_updated_by").value ='{{user_id}}';
	document.getElementById("bill_weight").value ='{{weight_sum}}';
	document.getElementById("bill_no_of_pallets").value ='{{no_of_pieces}}';
	document.getElementById("bill_tot_crane_time").value ='{{crane_time}}';
	document.getElementById("bill_tot_forklift_time").value ='{{forklift_time}}';
	document.getElementById("bill_loading_charge").value ='{{total_loading_cost}}';
	document.getElementById("bill_unloading_charge").value ='{{total_loading_cost}}';
	document.getElementById("bill_wh_storage_charges").value ='{{wh_storage_cost_sum}}';
	document.getElementById("bill_tot_crane_charges").value ='{{crane_cost_sum}}';
	document.getElementById("bill_tot_forklift_charges").value ='{{forklift_cost_sum}}';
	bvm_invoice=document.getElementById("bill_customer_name").value
	bill_start_date_val=document.getElementById("bill_start_date").value
	bill_end_date_val=document.getElementById("bill_end_date").value
	document.getElementById("bill_no_of_days").value='{{no_of_days}}';
	bill_no_of_days_val=document.getElementById("bill_no_of_days").value
	if (bill_start_date_val=="")
		document.getElementById("bill_start_date").value='{{min_check_in_time}}';
	else
		document.getElementById("bill_start_date").value=bill_start_date_val;

	if (bill_end_date_val=="")
		document.getElementById("bill_end_date").value='{{max_check_out_time}}';
	else
		document.getElementById("bill_end_date").value=bill_end_date_val;

<!--	if (bill_no_of_days_val==0)-->
<!--		document.getElementById("bill_no_of_days").value='{{no_of_days}}';-->
<!--	else-->
<!--		document.getElementById("bill_no_of_days").value=bill_no_of_days_val;-->

	if (bvm_invoice=="")
	{
		$('#bill_customer_name').removeClass('disable_a_href');
	}
	else
	{
		$('#bill_customer_name').addClass('disable_a_href');
	}
	fumigation_charge_change_fn()
});
</script>
<script>
    $("#bill_customer_name").change(function charge_change_fn() {
      var url = $("#invoice_add").attr("data-load_customer_model-url");
      var gatein_customer_id = $(this).find(":selected").text();
      var total_weight = document.getElementById("bill_weight").value;
      var no_of_pieces = document.getElementById("bill_no_of_pallets").value;
      var voucher_num = document.getElementById("bill_invoice_ref").value;
      $.ajax({
        url: url,
        data: {
          'lm_customer_name_id': gatein_customer_id,
          'total_weight': total_weight,
          'no_of_pieces': no_of_pieces,
          'voucher_num': voucher_num,
        },
		success: function (data) {
			var customer_model=JSON.parse(data)["customer_businessmodel_val"];
			var customer_short_name=JSON.parse(data)["customer_short_name_val"];
			var customer_code=JSON.parse(data)["customer_code_val"];
			var customer_gst=JSON.parse(data)["customer_GST_val"];
			var customer_person=JSON.parse(data)["customer_person_val"];
			var customer_contact=JSON.parse(data)["customer_contact_val"];
			var customer_address=JSON.parse(data)["customer_address_val"];
			var min_check_in_time=JSON.parse(data)["min_check_in_time"];
			var max_check_out_time=JSON.parse(data)["max_check_out_time"];
			var max_storage_days=JSON.parse(data)["max_storage_days"];
			document.getElementById("bill_customer_type").value =customer_model;
			document.getElementById("bill_customer_short_name").value =customer_short_name;
			document.getElementById("bill_customer_code").value =customer_code;
			document.getElementById("bill_customer_GST").value =customer_gst;
			document.getElementById("bill_customer_person").value =customer_person;
			document.getElementById("bill_customer_contact").value =customer_contact;
			document.getElementById("bill_customer_address").value =customer_address;
			bill_start_date_val=document.getElementById("bill_start_date").value
			bill_end_date_val=document.getElementById("bill_end_date").value
			bill_no_of_days_val=document.getElementById("bill_no_of_days").value
			if (bill_start_date_val=="")
				document.getElementById("bill_start_date").value=min_check_in_time;
			else
				document.getElementById("bill_start_date").value=bill_start_date_val;

			if (bill_end_date_val=="")
				document.getElementById("bill_end_date").value=max_check_out_time;
			else
				document.getElementById("bill_end_date").value=bill_end_date_val;

<!--			if (bill_no_of_days_val=="")-->
<!--				document.getElementById("bill_no_of_days").value=max_storage_days;-->
<!--			else-->
<!--				document.getElementById("bill_no_of_days").value=bill_no_of_days_val;-->

       		fumigation_charge_change_fn()
       }
      });
    }).change();
</script>

<script>
	function fumigation_charge_change_fn() {
		var fumigation_charges_val=document.getElementById("bill_tot_fumigation_charges").value
		var wh_storage_charges_val=document.getElementById("bill_wh_storage_charges").value
		var wh_loading_un_charges_val=document.getElementById("bill_loading_charge").value
		var tot_crane_charges_val=document.getElementById("bill_tot_crane_charges").value
		var tot_forklift_charges_val=document.getElementById("bill_tot_forklift_charges").value
		var total_pre_GST=(parseFloat(fumigation_charges_val))+(parseFloat(wh_storage_charges_val))+(parseFloat(wh_loading_un_charges_val))+(parseFloat(wh_loading_un_charges_val))+(parseFloat(tot_crane_charges_val))+(parseFloat(tot_forklift_charges_val));
		document.getElementById("bill_cgst").value=parseFloat(total_pre_GST*(9/100)).toFixed(2)
		document.getElementById("bill_sgst").value=parseFloat(total_pre_GST*(9/100)).toFixed(2)
		var total_post_GST=total_pre_GST+(total_pre_GST*(9/100)+total_pre_GST*(9/100))
		document.getElementById("bill_total_pre_gst").value =total_pre_GST.toFixed(2);
       	document.getElementById("bill_total_post_gst").value =total_post_GST.toFixed(2);

	}
</script>

{% endblock content %}