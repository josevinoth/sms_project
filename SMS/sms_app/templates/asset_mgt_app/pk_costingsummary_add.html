{% extends "asset_mgt_app/base.html" %}
{% load widget_tweaks %}
{% block content %}

<form method="POST" action="" id="costingsummary_add"   >
	{% csrf_token %}
	<div class="row">
		<div class="col-2"></div>
		<div class="col-8">
			<div class="container-fluid">
				<div class="card text-white bg-info mb-3" style="max-width: 100%;">
					<div class="card-header text-center"><h3>Add/Update Costing Summary</h3></div>
					<div class="card-body bg-light" >
						<div class="row">
							<div class="col-6">
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Assessment Number</span>
									</div>
									{% render_field form.cs_assessment_num id="cs_assessment_num" name="cs_assessment_num"   class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Wood Cost</span>
									</div>
									{% render_field form.cs_wood_cost id="cs_wood_cost"  class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Engineer Cost</span>
									</div>
									{% render_field form.cs_engineer_cost id="cs_engineer_cost" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Labour Cost</span>
									</div>
									{% render_field form.cs_labour_cost id="cs_labour_cost" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Crane Cost</span>
									</div>
									{% render_field form.cs_crane_cost id="cs_crane_cost" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">HT Cost</span>
									</div>
									{% render_field form.cs_ht_cost id="cs_ht_cost" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Management Cost</span>
									</div>
									{% render_field form.cs_management_cost id="cs_management_cost" class="form-control disable_a_href" %}
								</div>
							</div>
							<div class="col-6">
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Consumables Cost</span>
									</div>
									{% render_field form.cs_material_cost id="cs_material_cost" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Transport Cost</span>
									</div>
									{% render_field form.cs_transport_cost id="cs_transport_cost" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Cost(Without Margin)</span>
									</div>
									{% render_field form.cs_total_cost_wom id="cs_total_cost_wom"  class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Margin (%)</span>
									</div>
									{% render_field form.cs_margin id="cs_margin"  onchange="change_charge_type()" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Cost(With Margin)</span>
									</div>
									{% render_field form.cs_total_cost_wm id="cs_total_cost_wm"  class="form-control disable_a_href " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total CFT</span>
									</div>
									{% render_field form.cs_total_cft id="cs_total_cft"  onchange="change_charge_type()" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Rate Per CFT</span>
									</div>
									{% render_field form.cs_rate_per_cft id="cs_rate_per_cft"  class="form-control disable_a_href" %}
								</div>
								{% render_field form.cs_updated_by id="cs_updated_by" hidden="True" class="form-control" %}
							</div>
							<div class="container-fluid input-group input-group-sm mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text">Remarks</span>
								</div>
								{% render_field form.cs_remarks id="cs_remarks"  class="form-control" %}
							</div>
						</div>
						<div class="row">
							<div class="col-1"></div>
							<div class="col-10">
								<div class="message text-center">
									{% for message in messages %}
									<a {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</a>
									{% endfor %}
									<span id="unique_field_error" style="color: red;"></span>
								</div>
							</div>
							<div class="col-1"></div>
						</div>
						<button type="submit" class="btn btn-success "><i class="fas fa-check"></i> Submit</button>
						<a href="{% url 'costingsummary_list' %}" class="btn btn-danger float-right">
							<i class="fas fa-times"></i> Cancel
						</a>
					</div>
				</div>
			</div>
		</div>
		<div class="col-2"></div>
	</div>
</form>
<div class="container-fluid row">
	<!--    <div class="col-md-1">-->
	<!--        <a href="{% url 'home_page' %}" class="btn btn-primary btn-block btn-lg">-->
	<!--            <i class="fas fa-arrow-left"></i> Back-->
	<!--        </a>-->
	<!--    </div>-->
	<div class="col-md-2">
		<a href="{% url 'costing_insert' %}" id="add_costing" class="btn btn-success btn-block btn-lg">
			<i class="fas fa-plus"></i> Add/Modify Items
		</a>
	</div>
</div>
<hr>
<div class="container-fluid">
	<table  id="costing_list" class="table table-striped table-bordered">
		<thead class="thead-dark">
		<tr>
			<th>Created On</th>
			<th>Assessment Number</th>
			<th>Cost Type</th>
			<th>Stock Type</th>
			<th>Stock Description</th>
			<th>Length</th>
			<th>Width(inch)</th>
			<th>Height(inch)</th>
			<th>Quantity</th>
			<th>Size</th>
			<th>UOM</th>
			<th>CFT</th>
			<th>Rate</th>
			<th>Days</th>
			<th>Total Cost</th>
			<th>Updated at</th>
			<th>Updated By</th>
<!--			<th>Edit</th>-->
<!--			<th>Delete</th>-->
		</thead>
		<tbody>
		{% for costinginfo in costing_list %}
		<tr>
			<td> {{costinginfo.ct_created_at}}</td>
			<td> {{costinginfo.ct_assessment_num}}</td>
			<td> {{costinginfo.ct_cost_type}}</td>
			<td> {{costinginfo.ct_stock_type}}</td>
			<td> {{costinginfo.ct_stock_description}}</td>
			<td> {{costinginfo.ct_length}}</td>
			<td> {{costinginfo.ct_width}}</td>
			<td> {{costinginfo.ct_height}}</td>
			<td> {{costinginfo.ct_quantity}}</td>
			<td> {{costinginfo.ct_size}}</td>
			<td> {{costinginfo.ct_uom}}</td>
			<td> {{costinginfo.ct_cft}}</td>
			<td> {{costinginfo.ct_rate}}</td>
			<td> {{costinginfo.ct_days}}</td>
			<td> {{costinginfo.ct_total_cost}}</td>
			<td> {{costinginfo.ct_updated_at}}</td>
			<td> {{costinginfo.ct_updated_by}}</td>
<!--			<td>-->
<!--				<a class="btn btn-primary" href="{% url 'costing_update' costinginfo.id %}" class="btn btn-primary">-->
<!--					<i class="far fa-edit"></i>-->
<!--				</a>-->
<!--			</td>-->
<!--			<td>-->
<!--				<form action="{% url 'costing_delete' costinginfo.id %}" method="post" onclick="return confirm('Are you sure?');">-->
<!--					{% csrf_token %}-->
<!--					<button type="submit" class="btn btn-danger">-->
<!--						<i class="fas fa-trash-alt"></i>-->
<!--					</button>-->
<!--				</form>-->
<!--			</td>-->
		</tr>
		{% endfor %}
		</tbody>
	</table>
</div>
<script>
$(document).ready(function() {
	document.getElementById("cs_updated_by").value ='{{user_id}}';
	document.getElementById("cs_wood_cost").value ='{{wood_cost}}';
	document.getElementById("cs_engineer_cost").value ='{{engineer_cost}}';
	document.getElementById("cs_labour_cost").value ='{{labour_cost}}';
	document.getElementById("cs_crane_cost").value ='{{crane_cost}}';
	document.getElementById("cs_ht_cost").value ='{{ht_cost}}';
	document.getElementById("cs_management_cost").value ='{{management_cost}}';
	document.getElementById("cs_material_cost").value ='{{material_cost}}';
	document.getElementById("cs_transport_cost").value ='{{transport_cost}}';
	change_charge_type()
	$('#costing_list').DataTable({
        dom: 'lBfrtip',
        buttons: [
            'copy', 'csv', 'excel','print'
        ]
    });
	var assessment_num = document.getElementById("cs_assessment_num").value
    if (assessment_num =="")
	{
		$('#add_costing').addClass('disable_a_href');
	}
	else
	{
		$('#add_costing').removeClass('disable_a_href');
	}
	});
</script>

<script>
function change_charge_type() {
var wood_cost=parseFloat(document.getElementById("cs_wood_cost").value) || 0;
var engineer_cost=parseFloat(document.getElementById("cs_engineer_cost").value) || 0;
var labour_cost=parseFloat(document.getElementById("cs_labour_cost").value) || 0;
var crane_cost=parseFloat(document.getElementById("cs_crane_cost").value) || 0;
var ht_cost=parseFloat(document.getElementById("cs_ht_cost").value) || 0;
var management_cost=parseFloat(document.getElementById("cs_management_cost").value) || 0;
var material_cost=parseFloat(document.getElementById("cs_material_cost").value) || 0;
var transport_cost=parseFloat(document.getElementById("cs_transport_cost").value) || 0;
var margin=parseFloat(document.getElementById("cs_margin").value) || 0;
var total_cost_wo_m= wood_cost+engineer_cost+labour_cost+crane_cost+ht_cost+management_cost+material_cost+transport_cost
document.getElementById("cs_total_cost_wom").value=total_cost_wo_m.toFixed(2)
var margin_value=total_cost_wo_m*(margin/100)
var total_cost=margin_value+total_cost_wo_m

document.getElementById("cs_total_cost_wm").value=total_cost.toFixed(2)

var total_cft=parseFloat(document.getElementById("cs_total_cft").value) || 0;
var rate_per_cft=total_cost/total_cft
document.getElementById("cs_rate_per_cft").value=rate_per_cft.toFixed(2)
}
</script>
<!--Unique Field validation-->
<script>
    $(document).ready(function() {
        $('#cs_assessment_num').on('change', function() {
            var cs_assessment_num = $(this).val();

            // Send an AJAX request to check if the value exists in the database
            $.ajax({
                url: '{% url "costing_summary_check_unique_field" %}',
                data: {
                    'cs_assessment_num': cs_assessment_num
                },
                dataType: 'json',
                success: function(data) {
                    if (data.exists) {
                        $('#unique_field_error').text('This Record already exists.');
                    } else {
                        $('#unique_field_error').text('');
                    }
                }
            });
        });
    });
</script>
{% endblock content %}