{% extends "asset_mgt_app/base.html" %}
{% load widget_tweaks %}
{% block content %}

<form method="POST" action="" id="stockpurchases_add" data-stock_description-url="{% url 'load_stock_description' %}" >
	{% csrf_token %}
	<div class="row">
		<div class="col-2"></div>
		<div class="col-8">
			<div class="container-fluid">
				<div class="card text-white bg-info mb-3" style="max-width: 100%;">
					<div class="card-header text-center"><h3>Add/Update Stock Purchases</h3></div>
					<div class="card-body bg-light" >
						<div class="row">
							<div class="col-6">
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Bill/Return/New Order</span>
									</div>
									{% render_field form.sp_vendor_bill id="sp_vendor_bill" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Stock Purchases Number</span>
									</div>
									{% render_field form.sp_purchase_num id="sp_purchase_num" readonly="True"  class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Category</span>
									</div>
									{% render_field form.sp_category id="sp_category" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Stock Type</span>
									</div>
									{% render_field form.sp_stock_type id="sp_stock_type" onchange="change_charge_type()" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Stock Description</span>
									</div>
									{% render_field form.sp_stock_description id="sp_stock_description" onchange="change_charge_type()" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Source</span>
									</div>
									{% render_field form.sp_source id="sp_source" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Stock In Date</span>
									</div>
									{% render_field form.sp_stock_in_date id="sp_stock_in_date" type="Date" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<!--										<span class="input-group-text">Thick (mm)/Height (In)</span>-->
										<span class="input-group-text">Thick (mm)/Height (In) <i class="fas fa-info-circle" data-toggle="tooltip" data-placement="top" title="For wood in. For Plywood mm"></i></span>
									</div>
									{% render_field form.sp_thick_height id="sp_thick_height" onchange="change_charge_type()" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<!--										<span class="input-group-text">Width (In/Ft)</span>-->
										<span class="input-group-text">Width (In/Ft) <i class="fas fa-info-circle" data-toggle="tooltip" data-placement="top" title="For wood in. For Plywood ft"></i></span>
									</div>
									{% render_field form.sp_width id="sp_width" onchange="change_charge_type()" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Length (Ft)</span>
									</div>
									{% render_field form.sp_length id="sp_length" onchange="change_charge_type()" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Weight (Kg)</span>
									</div>
									{% render_field form.sp_weight id="sp_weight" onchange="change_charge_type()" class="form-control disable_a_href" %}
								</div>
							</div>
							<div class="col-6">
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<!--										<span class="input-group-text">CFT/SQFT</span>-->
										<span class="input-group-text">CFT/SQFT <i class="fas fa-info-circle" data-toggle="tooltip" data-placement="top" title="For wood CFT. For Plywood SQFT"></i></span>
									</div>
									{% render_field form.sp_cft id="sp_cft" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">UOM</span>
									</div>
									{% render_field form.sp_uom id="sp_uom" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Size</span>
									</div>
									{% render_field form.sp_size id="sp_size" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Quantity</span>
									</div>
									{% render_field form.sp_quantity id="sp_quantity" onchange="change_charge_type()" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total CFT/SQFT</span>
									</div>
									{% render_field form.sp_total_cft  id="sp_total_cft" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<!--										<span class="input-group-text">Rate (INR)</span>-->
										<span class="input-group-text">Rate CFT/SQFT/KG <i class="fas fa-info-circle" data-toggle="tooltip" data-placement="top" title="For wood enter Rate/CFT. For other enter Rate/Qty.For Reused wood enter Rate/KG"></i></span>
									</div>
									{% render_field form.sp_rate id="sp_rate" onchange="change_charge_type()" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Price (INR)</span>
									</div>
									{% render_field form.sp_price id="sp_price" class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">GST (%)</span>
									</div>
									{% render_field form.sp_gst id="sp_gst" onchange="change_charge_type()" class="form-control " %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">GST Amount (INR)</span>
									</div>
									{% render_field form.sp_gst_amount id="sp_gst_amount"  class="form-control disable_a_href" %}
								</div>
								<div class="input-group input-group-sm mb-3">
									<div class="input-group-prepend">
										<span class="input-group-text">Total Bill Amount (INR)</span>
									</div>
									{% render_field form.sp_totalbill_amount id="sp_totalbill_amount" class="form-control disable_a_href" %}
								</div>
								{% render_field form.sp_updated_by id="sp_updated_by" hidden="True" class="form-control" %}
							</div>
						</div>
						<div class="input-group input-group-sm mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">Remarks</span>
							</div>
							{% render_field form.sp_remarks id="sp_remarks" class="form-control" %}
						</div>
						<div class="row">
							<div class="col-1"></div>
							<div class="col-10">
								<div class="message text-center">
									{% for message in messages %}
									<a {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</a>
									{% endfor %}
								</div>
							</div>
							<div class="col-1"></div>
						</div>

						<button type="submit" class="btn btn-success "><i class="fas fa-check"></i> Submit</button>
						<a href="{% url 'stockpurchases_cancel' %}" class="btn btn-danger float-right">
							<i class="fas fa-times"></i> Cancel
						</a>
					</div>
				</div>
			</div>
		</div>
		<div class="col-2"></div>
	</div>
</form>
<script>
	$(document).ready(function() {
        document.getElementById("sp_updated_by").value ='{{user_id}}';
        var pk_vendor_bill='{{pk_vendor_bill}}'
        var sp_vendor_bill_val=document.getElementById("sp_vendor_bill").value
        if (sp_vendor_bill_val=="")
        {
            document.getElementById("sp_vendor_bill").value = '{{pk_vendor_bill}}'
        }
        else
        {
            document.getElementById("sp_vendor_bill").value = sp_vendor_bill_val
        }
        change_charge_type();
        });
</script>
<script>
	$("#sp_stock_type").change(function () {
       var url = $("#stockpurchases_add").attr("data-stock_description-url");
       var stock_type = $(this).val();
       $.ajax({
         url: url,
         data: {
           'stock_type': stock_type,
         },
         success: function (data) {
             console.log(data);
             $('#sp_stock_description').removeClass('disable_a_href');
             $("#sp_stock_description").empty();
             $('#sp_stock_description').empty().append("<option value='0'>--Select--</option>");
             var sp_stock_description_name=JSON.parse(data)["stock_description"];
             var sp_stock_description_id=JSON.parse(data)["stock_description_id"];
             var len = (sp_stock_description_id).length;
             $('#sp_stock_description').empty().append("<option value='0'>--Select--</option>");
             for( var i = 0; i<len; i++){
                 $("#sp_stock_description").append("<option value='"+sp_stock_description_id[i]+"'>"+sp_stock_description_name[i]+"</option>");
             }
         }
       });
     });
</script>
<script>
	function change_charge_type() {
		var jn = document.getElementById("sp_stock_type").value;

		if (jn == 1) {
			var jn1 = document.getElementById("sp_stock_description").value;
			if (jn1 == 11) {
				// Enable weight and disable other size fields
				$('#sp_weight').removeClass('disable_a_href');
				$('#sp_cft, #sp_total_cft').addClass('disable_a_href');
				$('#sp_uom, #sp_size').removeClass('disable_a_href');

				var weight = parseFloat(document.getElementById("sp_weight").value) || 0;
				var rate = parseFloat(document.getElementById("sp_rate").value) || 0;
				var price = rate * weight;
				document.getElementById("sp_price").value = price.toFixed(2);

				// Reset other size-related fields to 0
				document.getElementById("sp_width").value = 0.0;
				document.getElementById("sp_length").value = 0.0;
				document.getElementById("sp_thick_height").value = 0.0;
				document.getElementById("sp_cft").value = 0.0;
				document.getElementById("sp_total_cft").value = 0.0;

				var gst = parseFloat(document.getElementById("sp_gst").value) || 0;
				var gst_amount = price * (gst / 100);
				document.getElementById("sp_gst_amount").value = gst_amount.toFixed(2);

				var total_bill_amount = price + gst_amount;
				document.getElementById("sp_totalbill_amount").value = total_bill_amount.toFixed(2);
			} else {
				// Disable weight and enable other size fields
				$('#sp_weight').addClass('disable_a_href');
				$('#sp_thick_height, #sp_length, #sp_width').removeClass('disable_a_href');
				$('#sp_cft, #sp_total_cft, #sp_uom, #sp_size').addClass('disable_a_href');

				document.getElementById("sp_uom").value = "";
				document.getElementById("sp_size").value = 0;
				var weight = parseFloat(document.getElementById("sp_weight").value) || 0;
				var length = parseFloat(document.getElementById("sp_length").value) || 0;
				var height = parseFloat(document.getElementById("sp_thick_height").value) || 0;
				var width = parseFloat(document.getElementById("sp_width").value) || 0;
				var cft = (length * height * width) / 144;
				document.getElementById("sp_cft").value = cft.toFixed(2);

				var quantity = parseFloat(document.getElementById("sp_quantity").value) || 0;
				var total_cft = cft * quantity;
				document.getElementById("sp_total_cft").value = total_cft.toFixed(2);

				var rate = parseFloat(document.getElementById("sp_rate").value) || 0;
				var price = rate * total_cft;
				document.getElementById("sp_price").value = price.toFixed(2);

				var gst = parseFloat(document.getElementById("sp_gst").value) || 0;
				var gst_amount = price * (gst / 100);
				document.getElementById("sp_gst_amount").value = gst_amount.toFixed(2);

				var total_bill_amount = price + gst_amount;
				document.getElementById("sp_totalbill_amount").value = total_bill_amount.toFixed(2);
			}
		} else if (jn == 4) {
			// Logic for jn == 4
			$('#sp_thick_height, #sp_length, #sp_width').removeClass('disable_a_href');
			$('#sp_cft, #sp_total_cft, #sp_uom, #sp_size').addClass('disable_a_href');
			document.getElementById("sp_uom").value = "";
			document.getElementById("sp_size").value = 0;

			var weight = parseFloat(document.getElementById("sp_weight").value) || 0;
			var length = parseFloat(document.getElementById("sp_length").value) || 0;
			var width = parseFloat(document.getElementById("sp_width").value) || 0;
			var cft = length * width;
			document.getElementById("sp_cft").value = cft.toFixed(2);

			var quantity = parseFloat(document.getElementById("sp_quantity").value) || 0;
			var total_cft = cft * quantity;
			document.getElementById("sp_total_cft").value = total_cft.toFixed(2);

			var rate = parseFloat(document.getElementById("sp_rate").value) || 0;
			var price = rate * total_cft;
			document.getElementById("sp_price").value = price.toFixed(2);

			var gst = parseFloat(document.getElementById("sp_gst").value) || 0;
			var gst_amount = price * (gst / 100);
			document.getElementById("sp_gst_amount").value = gst_amount.toFixed(2);

			var total_bill_amount = price + gst_amount;
			document.getElementById("sp_totalbill_amount").value = total_bill_amount.toFixed(2);
		} else if (jn == 2) {
			// Logic for jn == 2
			$('#sp_thick_height').addClass('disable_a_href');
			var jn1 = document.getElementById("sp_stock_description").value;

			if ([14, 15, 23, 38, 39, 44, 45, 46].includes(parseInt(jn1))) {
				$('#sp_length, #sp_width').removeClass('disable_a_href');
				$('#sp_cft, #sp_total_cft, #sp_uom, #sp_size').addClass('disable_a_href');

				document.getElementById("sp_uom").value = "";
				document.getElementById("sp_size").value = 0;

				var weight = parseFloat(document.getElementById("sp_weight").value) || 0;
				var length = parseFloat(document.getElementById("sp_length").value) || 0;
				var width = parseFloat(document.getElementById("sp_width").value) || 0;
				var cft = length * width;
				document.getElementById("sp_cft").value = cft.toFixed(2);

				var quantity = parseFloat(document.getElementById("sp_quantity").value) || 0;
				var total_cft = cft * quantity;
				document.getElementById("sp_total_cft").value = total_cft.toFixed(2);

				var rate = parseFloat(document.getElementById("sp_rate").value) || 0;
				var price = rate * total_cft;
				document.getElementById("sp_price").value = price.toFixed(2);

				var gst = parseFloat(document.getElementById("sp_gst").value) || 0;
				var gst_amount = price * (gst / 100);
				document.getElementById("sp_gst_amount").value = gst_amount.toFixed(2);

				var total_bill_amount = price + gst_amount;
				document.getElementById("sp_totalbill_amount").value = total_bill_amount.toFixed(2);
			} else {
				$('#sp_length, #sp_width').addClass('disable_a_href');
				$('#sp_uom, #sp_size').removeClass('disable_a_href');

				var quantity = parseFloat(document.getElementById("sp_quantity").value) || 0;
				var rate = parseFloat(document.getElementById("sp_rate").value) || 0;
				var price = rate * quantity;
				document.getElementById("sp_price").value = price.toFixed(2);

				// Reset fields
				document.getElementById("sp_width").value = 0.0;
				document.getElementById("sp_length").value = 0.0;
				document.getElementById("sp_thick_height").value = 0.0;
				document.getElementById("sp_cft").value = 0.0;
				document.getElementById("sp_total_cft").value = 0.0;

				var gst = parseFloat(document.getElementById("sp_gst").value) || 0;
				var gst_amount = price * (gst / 100);
				document.getElementById("sp_gst_amount").value = gst_amount.toFixed(2);

				var total_bill_amount = price + gst_amount;
				document.getElementById("sp_totalbill_amount").value = total_bill_amount.toFixed(2);
			}
		} else {
			// Default case for other jn values
			$('#sp_thick_height, #sp_length, #sp_width, #sp_cft, #sp_total_cft').addClass('disable_a_href');
			$('#sp_uom, #sp_size').removeClass('disable_a_href');

			var quantity = parseFloat(document.getElementById("sp_quantity").value) || 0;
			var rate = parseFloat(document.getElementById("sp_rate").value) || 0;
			var price = rate * quantity;
			document.getElementById("sp_price").value = price.toFixed(2);

			// Reset fields
			document.getElementById("sp_width").value = 0.0;
			document.getElementById("sp_length").value = 0.0;
			document.getElementById("sp_thick_height").value = 0.0;
			document.getElementById("sp_cft").value = 0.0;
			document.getElementById("sp_total_cft").value = 0.0;

			var gst = parseFloat(document.getElementById("sp_gst").value) || 0;
			var gst_amount = price * (gst / 100);
			document.getElementById("sp_gst_amount").value = gst_amount.toFixed(2);

			var total_bill_amount = price + gst_amount;
			document.getElementById("sp_totalbill_amount").value = total_bill_amount.toFixed(2);
		}
	}
</script>

{% endblock content %}